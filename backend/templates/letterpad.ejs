<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @font-face {
      font-family: 'Vijaya';
      src: url('file://<%= fontPath %>') format('truetype');
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    @page {
      size: A4;
      margin: 15mm 0 20mm 0;
    }
    @page :first {
      margin: 0;
    }
    body {
      font-family: 'Times New Roman', serif;
      margin: 0;
      padding: 0;
    }
    .page {
      width: 210mm;
      min-height: 297mm;
      position: relative;
      box-sizing: border-box;
      background: white;
    }
    .first-page {
      padding: 0;
      position: relative;
    }
    .letterhead-container {
      position: relative;
      width: 210mm;
      margin: 0;
      padding: 0;
    }
    .text-frame {
      position: absolute;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .text-content {
      width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .content-area {
      width: 100%;
      max-width: 184.60mm;
      margin: 0 auto;
      font-size: 12pt;
      color: #000000;
      text-align: justify;
    }
    .content-area p {
      margin-bottom: 0.5em;
      page-break-inside: avoid;
    }
    .content-area table {
      page-break-inside: avoid;
    }
    /* Add top margin to elements that might start a new page */
    .content-area > *:first-child {
      margin-top: 0;
    }
    .shape {
      position: absolute;
    }
    .line {
      position: absolute;
    }
    .table-cell {
      position: absolute;
      overflow: hidden;
    }
    .image-frame {
      position: absolute;
    }
    .footer {
      position: fixed;
      bottom: 5mm;
      left: 12.70mm;
      right: 12.70mm;
      text-align: center;
      font-size: 8pt;
      color: #666;
    }
    .tamil-text {
      font-family: 'Vijaya', serif;
      font-size: 13.0pt;
    }
    .english-text {
      font-family: 'Times New Roman', serif;
      font-size: 12.0pt;
    }
    /* Preserve formatting */
    strong, b {
      font-weight: bold;
    }
    em, i {
      font-style: italic;
    }
    u {
      text-decoration: underline;
    }
    p {
      margin: 0;
      padding: 0;
    }
    /* Text content styling for rev name, designation, and address */
    .text-content p {
      margin: 0;
      padding: 0;
      line-height: 1.4;
    }
    .text-content p + p {
      margin-top: 0;
    }
    .text-content br {
      line-height: 1.4;
    }
    /* Text alignment */
    .editor-text-left, [style*="text-align: left"] {
      text-align: left !important;
    }
    .editor-text-center, [style*="text-align: center"] {
      text-align: center !important;
    }
    .editor-text-right, [style*="text-align: right"] {
      text-align: right !important;
    }
    .editor-text-justify, [style*="text-align: justify"] {
      text-align: justify !important;
    }
  </style>
</head>
<body>
<%
// Helper function to check if text contains Tamil characters
function isTamilText(text) {
  if (!text) return false;
  const tamilRegex = /[\u0B80-\u0BFF]/;
  return tamilRegex.test(text);
}

// Get font class based on text content
function getFontClass(text) {
  return isTamilText(text) ? 'tamil-text' : 'english-text';
}

// Get font size based on text content (Tamil gets +1pt)
function getFontSize(text, baseSize) {
  return isTamilText(text) ? (baseSize + 1) : baseSize;
}

// Calculate dynamic position for letterpad number and date based on content above
function calculateDynamicTop() {
  // Base top position (where rev details start)
  const baseTop = 43.42; // mm - starting position of rev details (adjusted for verse)

  // Helper function to count actual text lines in HTML content
  function countActualLines(htmlContent) {
    if (!htmlContent) return 1;

    // Remove all HTML tags to get plain text
    let textContent = htmlContent.replace(/<[^>]*>/g, ' ');

    // Replace multiple spaces with single space
    textContent = textContent.replace(/\s+/g, ' ').trim();

    // If empty, return 1
    if (!textContent) return 1;

    // Count <p> tags - each paragraph is a line
    const pCount = (htmlContent.match(/<p[^>]*>/gi) || []).length;

    // Count <br> tags - each break is a new line
    const brCount = (htmlContent.match(/<br\s*\/?>/gi) || []).length;

    // Total lines = paragraphs + line breaks + 1 (for first line)
    // But if we have paragraphs, don't add 1
    if (pCount > 0) {
      return pCount + brCount;
    } else if (brCount > 0) {
      return brCount + 1;
    } else {
      // Single line of text
      return 1;
    }
  }

  // Calculate lines in rev name (includes designation now)
  const revLines = countActualLines(letterpad.rev_name || '<strong>Rev. T SAMUEL</strong><br>Pastorate Chairman');

  // Calculate lines in parsonage_address
  const parsonageLines = countActualLines(letterpad.parsonage_address || 'Christ Church Parsonage<br>14, Zion Church Street,<br>Samathanapuram<br>Tenkasi<br>Ph:75388122218');

  // Line height is approximately 5.5mm per line (based on 13pt font with 1.4 line-height)
  const lineHeight = 5.5;

  // Use the maximum of the two sections
  const maxLines = Math.max(revLines, parsonageLines);

  // Calculate new top position with proper gap
  const calculatedTop = baseTop + (maxLines * lineHeight) + 8; // 8mm padding for proper gap

  // No minimum - let it be truly dynamic
  return calculatedTop;
}

const dynamicTop = calculateDynamicTop();
const contentStartTop = dynamicTop + (letterpad.subject && letterpad.subject.trim() ? 20 : 10);

// Process HTML content to apply font classes character by character
function processContentHTML(htmlContent) {
  if (!htmlContent) return '';

  // Split by tags and process text nodes
  const parts = htmlContent.split(/(<[^>]+>)/g);
  const result = parts.map(part => {
    // If it's a tag, return as is
    if (part.startsWith('<') && part.endsWith('>')) {
      return part;
    }

    // If it's text content, process character by character
    if (part) {
      let processedText = '';
      let currentSegment = '';
      let currentIsTamil = null;

      for (let i = 0; i < part.length; i++) {
        const char = part[i];
        const charIsTamil = isTamilText(char);

        // If font type changes or first character
        if (currentIsTamil === null) {
          currentIsTamil = charIsTamil;
          currentSegment = char;
        } else if (currentIsTamil === charIsTamil) {
          // Same font type, add to current segment
          currentSegment += char;
        } else {
          // Font type changed, wrap current segment and start new one
          const fontClass = currentIsTamil ? 'tamil-text' : 'english-text';
          processedText += `<span class="${fontClass}">${currentSegment}</span>`;
          currentSegment = char;
          currentIsTamil = charIsTamil;
        }
      }

      // Wrap the last segment
      if (currentSegment) {
        const fontClass = currentIsTamil ? 'tamil-text' : 'english-text';
        processedText += `<span class="${fontClass}">${currentSegment}</span>`;
      }

      return processedText;
    }
    return part;
  }).join('');

  return result;
}
%>

<!-- First Page with Letterhead -->
<div class="page first-page">

  <!-- Letterhead Container (absolute positioning) -->
  <div class="letterhead-container" style="height: <%= dynamicTop + 8 %>mm;">

  <!-- CSI Logo -->
  <div class="image-frame" style="
    left: 12.70mm;
    top: 12.80mm;
    width: 21.35mm;
    height: 21.35mm;
    overflow: hidden;
  ">
    <img src="<%= csiLogoBase64 %>" style="width: 100%; height: 100%; object-fit: cover;" />
  </div>

  <!-- Diocese Logo -->
  <div class="image-frame" style="
    left: 183.77mm;
    top: 12.03mm;
    width: 13.53mm;
    height: 22.89mm;
    overflow: hidden;
  ">
    <img src="<%= dioceseLogoBase64 %>" style="width: 100%; height: 100%; object-fit: cover;" />
  </div>

  <!-- Verse -->
  <div class="text-frame" style="
    left: 12.70mm;
    top: 14.70mm;
    width: 184.60mm;
    height: 4.00mm;
  ">
    <div class="text-content" style="
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      font-size: 10.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: center;
      font-style: italic;
    "><%= letterpad.verse || 'Fear of the Lord is the beginning of wisdom' %></div>
  </div>

  <!-- Diocese Name -->
  <div class="text-frame" style="
    left: 12.70mm;
    top: 20.70mm;
    width: 184.60mm;
    height: 5.47mm;
  ">
    <div class="text-content" style="
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      font-size: 12.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: center;
      font-weight: bold;
      text-transform: uppercase;
    "><%= letterpad.diocese_name || 'CHURCH OF SOUTH INDIA - TIRUNELVELI DIOCESE' %></div>
  </div>

  <!-- Pastorate Name -->
  <div class="text-frame" style="
    left: 12.70mm;
    top: 27.42mm;
    width: 184.60mm;
    height: 8.73mm;
  ">
    <div class="text-content" style="
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      font-size: 15.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: center;
      font-weight: bold;
      text-transform: uppercase;
    "><%= letterpad.pastorate_name || '' %></div>
  </div>

  <!-- Chairman Details (Rev Name and Designation) -->
  <div class="text-frame" style="
    left: 12.70mm;
    top: 43.42mm;
    width: 72.63mm;
    height: auto;
    max-height: 50mm;
  ">
    <div class="text-content" style="
      width: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      font-size: 13.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: left;
      line-height: 1.4;
    "><%- letterpad.rev_name || '<strong>Rev. T SAMUEL</strong><br>Pastorate Chairman' %></div>
  </div>

  <!-- Parsonage Address -->
  <div class="text-frame" style="
    left: 148.33mm;
    top: 43.42mm;
    width: 56.97mm;
    height: auto;
    max-height: 50mm;
  ">
    <div class="text-content" style="
      width: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      font-size: 13.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: left;
      line-height: 1.4;
    "><%- letterpad.parsonage_address || 'Christ Church Parsonage<br>14, Zion Church Street,<br>Samathanapuram<br>Tenkasi<br>Ph:75388122218' %></div>
  </div>

  <!-- Horizontal Line (Dynamic position based on address height) -->
  <svg class="line" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;">
    <line x1="12.70mm" y1="<%= dynamicTop - 2 %>mm" x2="197.30mm" y2="<%= dynamicTop - 2 %>mm" stroke="<%= letterpad.line_color || '#000000' %>" stroke-width="0.35mm" />
  </svg>

  <!-- Letterpad Number -->
  <div class="text-frame" style="
    left: 12.70mm;
    top: <%= dynamicTop %>mm;
    width: 41.00mm;
    height: 5.10mm;
  ">
    <div class="text-content" style="
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      font-size: 12.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: left;
    "><%= letterpad.letterpad_number %></div>
  </div>

  <!-- Date Label and Date -->
  <div class="text-frame" style="
    left: 154.00mm;
    top: <%= dynamicTop %>mm;
    width: 43.30mm;
    height: 5.47mm;
  ">
    <div class="text-content" style="
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: 0.00mm 0.00mm 0.00mm 0.00mm;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: flex-start;
      font-size: 12.0pt;
      font-family: 'Times New Roman', serif;
      color: #000000;
      text-align: left;
    ">Date : <%= formatDate(letterpad.letter_date) %></div>
  </div>

  </div>
  <!-- End Letterhead Container -->

  <!-- Subject (if exists) -->
  <% if (letterpad.subject && letterpad.subject.trim()) { %>
  <div style="margin-top: 10mm; margin-bottom: 5mm; margin-left: 12.70mm; margin-right: 12.70mm;">
    <strong><u>Sub: <%= letterpad.subject %></u></strong>
  </div>
  <% } else { %>
  <!-- Add spacing even if no subject -->
  <div style="margin-top: 10mm;"></div>
  <% } %>

  <!-- Main Content -->
  <div class="content-area" style="margin-left: 12.70mm; margin-right: 12.70mm; margin-bottom: 25mm; line-height: 1.5;">
    <%- processContentHTML(letterpad.content || '') %>
  </div>

</div>

<!-- Footer (appears on every page) -->
<div class="footer">
  <span><%= letterpad.letterpad_number %></span>
  <span style="margin: 0 10px;">|</span>
  <span class="pageNumber"></span>
</div>

<script>
  // Add page numbers
  const pageNumbers = document.querySelectorAll('.pageNumber');
  pageNumbers.forEach((el, index) => {
    el.textContent = `Page ${index + 1}`;
  });
</script>

</body>
</html>